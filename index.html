<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>おつまみ牛ゲーム</title>

<style>
  body {
    margin: 0;
    background: #e9f3e6;
    font-family: sans-serif;
    text-align: center;
  }

  #ui {
    padding: 10px 0;
  }

  #score {
    font-size: 22px;
  }

  #best {
    font-size: 14px;
    color: #666;
  }

  #combo {
    font-size: 16px;
    color: orange;
    margin-top: 6px;
  }

  canvas {
    display: block;
    margin: 0 auto;
    background: #e9f3e6;
  }
</style>
</head>

<body>
  <div id="ui">
    <div id="score">スコア：0</div>
    <div id="best">ベストスコア：0</div>
    <div id="combo"></div>
  </div>

  <canvas id="game" width="360" height="520"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let score = 0;
let bestScore = localStorage.getItem("bestScore") || 0;
let combo = 0;
let gameOver = false;

/* ==== 画像 ==== */
const cowImg = new Image();
cowImg.src = "cow.png"; // 牛画像

const onionImg = new Image();
onionImg.src = "onion.png"; // 玉ねぎ画像

const wheatImg = new Image();
wheatImg.src = "wheat.png"; // 小麦画像

/* ==== 牛 ==== */
const cow = {
  x: 180,
  y: 420,
  width: 100,
  height: 100,
  speed: 5
};

/* ==== 落下物 ==== */
let items = [];

/* ==== 地面 ==== */
const groundHeight = 24;

/* ==== 入力 ==== */
let left = false;
let right = false;

document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft") left = true;
  if (e.key === "ArrowRight") right = true;
});
document.addEventListener("keyup", e => {
  if (e.key === "ArrowLeft") left = false;
  if (e.key === "ArrowRight") right = false;
});

/* ==== スマホ操作 ==== */
canvas.addEventListener("touchstart", e => {
  const x = e.touches[0].clientX;
  if (x < window.innerWidth / 2) left = true;
  else right = true;
});
canvas.addEventListener("touchend", () => {
  left = false;
  right = false;
});

/* ==== 当たり判定（縮小） ==== */
function hit(a, b, shrink = 0.5) {
  const aw = a.width * shrink;
  const ah = a.height * shrink;
  const ax = a.x + (a.width - aw) / 2;
  const ay = a.y + (a.height - ah) / 2;

  return (
    ax < b.x + b.width &&
    ax + aw > b.x &&
    ay < b.y + b.height &&
    ay + ah > b.y
  );
}

/* ==== アイテム生成 ==== */
function spawnItem() {
  const isOnion = Math.random() < 0.3;
  items.push({
    x: Math.random() * (canvas.width - 40),
    y: -40,
    width: 40,
    height: 40,
    speed: 2 + Math.random() * 2,
    type: isOnion ? "onion" : "wheat"
  });
}

/* ==== 更新 ==== */
function update() {
  if (gameOver) return;

  if (left) cow.x -= cow.speed;
  if (right) cow.x += cow.speed;

  cow.x = Math.max(0, Math.min(canvas.width - cow.width, cow.x));

  items.forEach(item => item.y += item.speed);

  items = items.filter(item => {
    if (item.type === "onion") {
      if (hit(cow, item, 0.45)) {
        gameOver = true;
        bestScore = Math.max(bestScore, score);
        localStorage.setItem("bestScore", bestScore);
        return false;
      }
    } else {
      if (hit(cow, item, 0.8)) {
        score += 10;
        combo++;
        return false;
      }
    }
    return item.y < canvas.height;
  });

  if (Math.random() < 0.03) spawnItem();
}

/* ==== 描画 ==== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* 地面 */
  ctx.fillStyle = "#6fbf73";
  ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);

  /* 牛 */
  ctx.drawImage(cowImg, cow.x, cow.y, cow.width, cow.height);

  /* アイテム */
  items.forEach(item => {
    const img = item.type === "onion" ? onionImg : wheatImg;
    ctx.drawImage(img, item.x, item.y, item.width, item.height);
  });

  /* UI */
  document.getElementById("score").textContent = "スコア： " + score;
  document.getElementById("best").textContent = "ベストスコア： " + bestScore;
  document.getElementById("combo").textContent =
    combo >= 2 ? combo + " COMBO!" : "";

  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "28px sans-serif";
    ctx.fillText("GAME OVER", 90, 250);
  }
}

/* ==== ループ ==== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
